{% extends "progres_search/base.html" %}

{% block title %}Progres results{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/2.1.3/css/dataTables.dataTables.css" />
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.3/js/dataTables.js"></script>

<a href="{% url 'progres_search:index' %}">
    Home
</a>

<h1>
    Progres results
</h1>

<div id="results_left">
    <ul>
        <li>Job name: {{ submission.job_name }}</li>
        <li>Query size: {{ submission.n_res_total }} residues</li>
        <li>n domains: {{ n_domains }} ( jump to
            {% for i in domains_iter %}
                <a href="#domain_{{ i }}">{{ i }} </a>
            {% endfor %}
        )</li>
        <li>Database: {{ submission.targetdb }}</li>
        <li>Parameters: minsimilarity {{ submission.minsimilarity }}, maxhits {{ submission.maxhits }}, chainsaw {{ chainsaw_str }}, faiss {{ faiss_str }}, progres v{{ progres_version }}</li>
    </ul>

    {% for domain_n, domain_size, domain_res_range, results in domains_zip %}
        <h3 id="domain_{{ domain_n }}">
            Domain {{ domain_n }}
        </h3>

        <a href="#">
            top
        </a>

        <ul>
            <li>Domain size: {{ domain_size }} residues ({{ domain_res_range }}, renumbering query from 1)</li>
        </ul>

        <table id="table_{{ domain_n }}">
            <thead>
                <tr>
                    <th>Hit n</th>
                    <th>Domain</th>
                    <th>Hit nres</th>
                    <th>Similarity</th>
                    <th>Notes</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody>
                {% for domain, hit_nres, similarity, note, url, res_range in results %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ domain }}</td>
                        <td>{{ hit_nres }}</td>
                        <td>{{ similarity }}</td>
                        <td>{{ note }}</td>
                        <td>
                            <button onclick="view_structure('{{ url }}', '{{ res_range }}', {{ domain_n }}, {{ forloop.counter }});">
                                View
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
</div>

<div id="results_right">
    <h3 id="query_info">
        Query domain
    </h3>

    <div id="viewer_query"></div>

    <h3>
        Selected hit domain
    </h3>

    <div id="viewer_target"></div>

    <ul>
        <li>Hit n: <span id="hit_info_n"></span></li>
        <li>Download URL: <span id="hit_info_url"></span></li>
        <li>Residue range: <span id="hit_info_res"></span></li>
    </ul>
</div>

<script>
    function view_structure(url, res_range, domain_n, hit_n) {
        let element_query = $("#viewer_query");
        let element_target = $("#viewer_target");
        let config = {backgroundColor: "white"};
        let ss_colours = { h: 0xff0000, s: 0xffff00, c: 0x00ff00 }
        let viewer_query = $3Dmol.createViewer(element_query, config);
        let viewer_target = $3Dmol.createViewer(element_target, config);
        let query_dom_pdbs = [
            {% for query_dom_pdb in query_dom_pdbs %}
                `{{ query_dom_pdb }}`,
            {% endfor %}
        ];
        let resrange_list = res_range.split("_");

        jQuery.ajax(url, {
            success: function(target_pdb) {
                viewer_query.addModel(query_dom_pdbs[domain_n - 1], "pdb");
                viewer_query.setStyle({}, {cartoon: {colorscheme: {prop:"ss", map:ss_colours}}});
                viewer_query.zoomTo();
                viewer_query.render();

                viewer_target.addModel(target_pdb, "pdb");
                viewer_target.setStyle({}, {cartoon: {color: "grey", opacity: 0.7}});
                for (var i = 0; i < resrange_list.length; i++) {
                    viewer_target.setStyle(
                        {resi: resrange_list[i]},
                        {cartoon: {colorscheme: {prop:"ss", map:ss_colours}}},
                    );
                }
                viewer_target.zoomTo();
                viewer_target.render();
                $("#query_info").html("Query domain " + domain_n)
                $("#hit_info_n").html(hit_n)
                $("#hit_info_url").html("<a href='" + url + "'>" + url + "</a>")
                $("#hit_info_res").html(res_range)
            },
            error: function(hdr, status, err) {
                console.error("Failed to load PDB " + url + ": " + err);
            },
        });
    };

    $(document).ready( function () {
        view_structure('{{ url_start }}', '{{ res_range_start }}', 1, 1);
        {% for i in domains_iter %}
            $("#table_{{ i }}").DataTable();
        {% endfor %}
    });
</script>

{% endblock %}
