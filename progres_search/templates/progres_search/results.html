{% extends "progres_search/base.html" %}

{% block title %}Progres results{% endblock %}

{% block content %}

<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    function view_structure(url, res_range, hit_n) {
        let element = $("#viewer_target");
        let config = {backgroundColor: "white"};
        let viewer = $3Dmol.createViewer(element, config);
        let resrange_list = res_range.split("_");
        jQuery.ajax(url, {
            success: function(data) {
                viewer.addModel(data, "pdb");
                viewer.setStyle({}, {cartoon: {color: "grey", opacity: 0.8}});
                for (var i = 0; i < resrange_list.length; i++) {
                    viewer.setStyle(
                        {resi: resrange_list[i]},
                        {cartoon: {color: "red"}},
                    );
                }
                viewer.zoomTo();
                viewer.render();
                $("#hit_info_n").html(hit_n)
                $("#hit_info_url").html("<a href='" + url + "'>" + url + "</a>")
                $("#hit_info_res").html(res_range)
            },
            error: function(hdr, status, err) {
                console.error("Failed to load PDB " + url + ": " + err);
            },
        });
    };
</script>

<a href="{% url 'progres_search:index' %}">
    Home
</a>

<h1>
    Progres results
</h1>

<div id="results_left">
    <ul>
        <li>Job name: {{ submission.job_name }}</li>
        <li>Query size: {{ submission.n_residues }} residues</li>
        <li>Database: {{ submission.targetdb }}</li>
        <li>Parameters: minsimilarity {{ submission.minsimilarity }}, maxhits {{ submission.maxhits }}, progres v{{ progres_version }}{{ faiss_str }}</li>
    </ul>

    <table>
        <tr>
            <th>Hit n</th>
            <th>Domain</th>
            <th>Hit nres</th>
            <th>Similarity</th>
            <th>Notes</th>
            <th>View</th>
        </tr>
        {% for domain, hit_nres, similarity, note, url, res_range in results %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ domain }}</td>
                <td>{{ hit_nres }}</td>
                <td>{{ similarity }}</td>
                <td>{{ note }}</td>
                <td>
                    <button onclick="view_structure('{{ url }}', '{{ res_range }}', '{{ forloop.counter }}');">
                        View
                    </button>
                </td>
            </tr>
        {% endfor %}
    </table>
</div>

<div id="results_right">
    <h2>
        Selected hit structure
    </h2>

    <div id="viewer_target"></div>

    <ul>
        <li>Hit n: <span id="hit_info_n"></span></li>
        <li>Download URL: <span id="hit_info_url"></span></li>
        <li>Residue range: <span id="hit_info_res"></span></li>
    </ul>
</div>

{% endblock %}
